

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="一、ElasticSearch已经在另一篇博客单独介绍：ElasticSearch 二、商城业务1、商品上架 如果每个 sku 都存储规格参数，会有冗余存储，因为每个 spu 对应的 sku 的规格参数都一样 但是如果将规格参数单独建立索引会出现检索时出现大量数据传输的问题，会阻塞网络 因此我们选用第一种存储模型，以空间换时间    向 es 添加商品属性映射  12345678910111213">
<meta property="og:type" content="article">
<meta property="og:title" content="2020-12-27-谷粒商城-分布式高级篇">
<meta property="og:url" content="http://example.com/2022/08/13/yuque/2020-12-27-%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E-%E5%88%86%E5%B8%83%E5%BC%8F%E9%AB%98%E7%BA%A7%E7%AF%87/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="一、ElasticSearch已经在另一篇博客单独介绍：ElasticSearch 二、商城业务1、商品上架 如果每个 sku 都存储规格参数，会有冗余存储，因为每个 spu 对应的 sku 的规格参数都一样 但是如果将规格参数单独建立索引会出现检索时出现大量数据传输的问题，会阻塞网络 因此我们选用第一种存储模型，以空间换时间    向 es 添加商品属性映射  12345678910111213">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/1311678686.png#crop=0&crop=0&crop=1&crop=1&id=m66Mk&originHeight=1104&originWidth=900&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=">
<meta property="og:image" content="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/823710575.png#crop=0&crop=0&crop=1&crop=1&id=XlP7G&originHeight=928&originWidth=1634&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=">
<meta property="og:image" content="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/3270550004.png#crop=0&crop=0&crop=1&crop=1&id=Cskl1&originHeight=938&originWidth=1648&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=">
<meta property="og:image" content="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/211114208.png#crop=0&crop=0&crop=1&crop=1&id=zXiFA&originHeight=780&originWidth=1212&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=">
<meta property="og:image" content="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/1485346018.png#crop=0&crop=0&crop=1&crop=1&id=slNPS&originHeight=872&originWidth=1540&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=">
<meta property="og:image" content="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/2709477518.png#crop=0&crop=0&crop=1&crop=1&id=PJHFm&originHeight=818&originWidth=1434&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=">
<meta property="og:image" content="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/2530788904.png#crop=0&crop=0&crop=1&crop=1&id=ri3hy&originHeight=816&originWidth=1432&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=">
<meta property="og:image" content="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/918823800.png#crop=0&crop=0&crop=1&crop=1&id=lSmfI&originHeight=800&originWidth=1400&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=">
<meta property="og:image" content="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/3007685876.png#crop=0&crop=0&crop=1&crop=1&id=eKKJG&originHeight=814&originWidth=1432&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=">
<meta property="og:image" content="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/3793875596.png#crop=0&crop=0&crop=1&crop=1&id=evgKy&originHeight=814&originWidth=1424&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=">
<meta property="og:image" content="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/1806484557.png#crop=0&crop=0&crop=1&crop=1&id=qtqGJ&originHeight=988&originWidth=1728&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=">
<meta property="og:image" content="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/115738156.png#crop=0&crop=0&crop=1&crop=1&id=bVPX2&originHeight=978&originWidth=1724&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=">
<meta property="og:image" content="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/1429316127.png#crop=0&crop=0&crop=1&crop=1&id=O5Jjh&originHeight=852&originWidth=1498&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=">
<meta property="og:image" content="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/3730737143.png#crop=0&crop=0&crop=1&crop=1&id=zeO9D&originHeight=530&originWidth=712&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=">
<meta property="og:image" content="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/3324269510.png#crop=0&crop=0&crop=1&crop=1&id=xxTD9&originHeight=410&originWidth=1418&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=">
<meta property="og:image" content="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/426564177.png#crop=0&crop=0&crop=1&crop=1&id=fAcqK&originHeight=490&originWidth=1360&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=">
<meta property="og:image" content="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/3401742783.png#crop=0&crop=0&crop=1&crop=1&id=eFWMj&originHeight=694&originWidth=1374&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=">
<meta property="og:image" content="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/2453611928.png#crop=0&crop=0&crop=1&crop=1&id=nefU6&originHeight=554&originWidth=1290&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=">
<meta property="og:image" content="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/1736970932.png#crop=0&crop=0&crop=1&crop=1&id=X3iBR&originHeight=604&originWidth=1274&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=">
<meta property="og:image" content="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/15217330.png#crop=0&crop=0&crop=1&crop=1&id=aM4h1&originHeight=442&originWidth=1482&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=">
<meta property="article:published_time" content="2022-08-13T13:41:10.000Z">
<meta property="article:modified_time" content="2022-10-09T14:52:18.803Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/1311678686.png#crop=0&crop=0&crop=1&crop=1&id=m66Mk&originHeight=1104&originWidth=900&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=">
  
  
  
  <title>2020-12-27-谷粒商城-分布式高级篇 - Hexo</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.3","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="2020-12-27-谷粒商城-分布式高级篇"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-08-13 21:41" pubdate>
          August 13, 2022 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          15k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          128 mins
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">2020-12-27-谷粒商城-分布式高级篇</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="一、ElasticSearch"><a href="#一、ElasticSearch" class="headerlink" title="一、ElasticSearch"></a>一、ElasticSearch</h1><p>已经在另一篇博客单独介绍：<a target="_blank" rel="noopener" href="http://polaris.ink/index.php/archives/147/">ElasticSearch</a></p>
<h1 id="二、商城业务"><a href="#二、商城业务" class="headerlink" title="二、商城业务"></a>二、商城业务</h1><h2 id="1、商品上架"><a href="#1、商品上架" class="headerlink" title="1、商品上架"></a>1、商品上架</h2><ul>
<li>如果每个 sku 都存储规格参数，会有冗余存储，因为每个 spu 对应的 sku 的规格参数都一样</li>
<li>但是如果将规格参数单独建立索引会出现检索时出现大量数据传输的问题，会阻塞网络</li>
<li>因此我们选用第一种存储模型，以空间换时间</li>
</ul>
<p><img src="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/1311678686.png#crop=0&crop=0&crop=1&crop=1&id=m66Mk&originHeight=1104&originWidth=900&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>向 es 添加商品属性映射</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs json">PUT product<br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;mappings&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;properties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;skuId&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;long&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;spuId&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;keyword&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;skuTitle&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;text&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;analyzer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ik_smart&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;skuPrice&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;keyword&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;skuImg&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;keyword&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;doc_values&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;saleCount&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;long&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;hasStock&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;boolean&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;hotScore&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;long&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;brandId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;long&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;catalogId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;long&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;brandName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;keyword&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;doc_values&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;brandImg&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;keyword&quot;</span><span class="hljs-punctuation">,</span><br>                 <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;doc_values&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;catalogName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;keyword&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;doc_values&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;attrs&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;nested&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;properties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;attrId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;long&quot;</span><br>                    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;attrName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;keyword&quot;</span><span class="hljs-punctuation">,</span><br>                        <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>                        <span class="hljs-attr">&quot;doc_values&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><br>                    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;attrValue&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;keyword&quot;</span><br>                    <span class="hljs-punctuation">&#125;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>批量操作</li>
</ul>
<h2 id="2、首页"><a href="#2、首页" class="headerlink" title="2、首页"></a>2、首页</h2><blockquote>
<p>动静分离:静态资源：图片、js、css 等静态资源，以实际文件存在等方式。动态资源：服务器需要处理等请求。将其分离开</p>
<p>每个微服务都能独立部署、运行、升级、独立自治</p>
</blockquote>
<p><img src="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/823710575.png#crop=0&crop=0&crop=1&crop=1&id=XlP7G&originHeight=928&originWidth=1634&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>1、引入 thymeleaf，关闭缓存</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--thymeleaf--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><br>spring:<br>  thymeleaf:<br>    # 开发期间关闭<br>    cache: false<br>  # 复制的index.html已经href加了static前缀<br>  mvc:<br>    static-path-pattern: /static/**<br></code></pre></td></tr></table></figure>

<ul>
<li>2、静态资源放在 template 下，直接访问可以成功</li>
</ul>
<p><strong>原因</strong>：SpringBoot 有默认配置</p>
<ul>
<li>3、引入 devtools 实现不重启更新前端 thymeleaf</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-devtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h2 id="3、域名访问"><a href="#3、域名访问" class="headerlink" title="3、域名访问"></a>3、域名访问</h2><p><strong>注意</strong>：为了访问快，使用本机开发和部署</p>
<p><img src="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/3270550004.png#crop=0&crop=0&crop=1&crop=1&id=Cskl1&originHeight=938&originWidth=1648&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>修改 hosts</li>
</ul>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs accesslog"><br>vim /etc/hosts<br><br><span class="hljs-number">127.0.0.1</span>	gulimall.com<br><span class="hljs-number">127.0.0.1</span>	search.gulimall.com<br><span class="hljs-number">127.0.0.1</span>	item.gulimall.com<br><span class="hljs-number">127.0.0.1</span>	member.gulimall.com<br></code></pre></td></tr></table></figure>

<ul>
<li>让 nginx 反向代理</li>
</ul>
<p>所有来自 gulimall.com 都转发到商品服务</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs awk">vim <span class="hljs-regexp">/Users/</span>lqs<span class="hljs-regexp">/mydata/</span>nginx<span class="hljs-regexp">/conf/</span>conf.d/gulimall.conf<br><br><br>listen       <span class="hljs-number">80</span>;<br>server_name  gulimall.com;<br><br>  <span class="hljs-comment">#charset koi8-r;</span><br>  <span class="hljs-comment">#access_log  /var/log/nginx/log/host.access.log  main;</span><br><br>  location / &#123;<br>      <span class="hljs-comment"># nginx代理给网关的时候，会丢失请求的host，自己手动加上</span><br>      proxy_set_header Host <span class="hljs-variable">$host</span>;<br>      proxy_pass http:<span class="hljs-regexp">//gu</span>limall;<span class="hljs-comment">#本机ip</span><br>  &#125;<br></code></pre></td></tr></table></figure>

<h2 id="4、负载均衡到-nginx"><a href="#4、负载均衡到-nginx" class="headerlink" title="4、负载均衡到 nginx"></a>4、负载均衡到 nginx</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs awk">vim <span class="hljs-regexp">/Users/</span>lqs<span class="hljs-regexp">/mydata/</span>nginx<span class="hljs-regexp">/conf/</span>nginx.conf<br><br>http &#123;<br>     upstream gulimall&#123;<br>         server <span class="hljs-number">100.84</span>.<span class="hljs-number">69.85</span>:<span class="hljs-number">88</span><span class="hljs-comment">#本机ip</span><br>     &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>配置 gateway</li>
</ul>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">spring</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-attribute">cloud</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">gateway</span><span class="hljs-punctuation">:</span><br>      <span class="hljs-attribute">routes</span><span class="hljs-punctuation">:</span><br>	<span class="hljs-comment"># 该route必须放在最后面</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">id: gulimall_host_route</span><br>          <span class="hljs-attribute">uri</span><span class="hljs-punctuation">:</span> <span class="hljs-string">lb://gulimall-product</span><br>          <span class="hljs-attribute">predicates</span><span class="hljs-punctuation">:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Host=**.gulimall.com</span><br></code></pre></td></tr></table></figure>

<h2 id="5、动静分离"><a href="#5、动静分离" class="headerlink" title="5、动静分离"></a>5、动静分离</h2><p><img src="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/211114208.png#crop=0&crop=0&crop=1&crop=1&id=zXiFA&originHeight=780&originWidth=1212&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>将静态资源 index 文件夹放进 html&#x2F;static 目录下</li>
</ul>
<p><img src="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/1485346018.png#crop=0&crop=0&crop=1&crop=1&id=slNPS&originHeight=872&originWidth=1540&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>删除项目下 index 目录</li>
<li>index.html 中所有路径加上&#x2F;static（之前已经加上了），删除配置文件中 mvc&#x2F;resources 部分</li>
<li>修改 gulimall.conf</li>
</ul>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs awk">vim <span class="hljs-regexp">/Users/</span>lqs<span class="hljs-regexp">/mydata/</span>nginx<span class="hljs-regexp">/conf/</span>conf.d/gulimall.conf<br><br> <span class="hljs-number">9</span>     location <span class="hljs-regexp">/static/</span> &#123;<br><span class="hljs-number">10</span>          root   <span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/nginx/</span>html;<br><span class="hljs-number">11</span>     &#125;<br><span class="hljs-number">12</span><br><span class="hljs-number">13</span>     location / &#123;<br><span class="hljs-number">14</span>         proxy_set_header Host <span class="hljs-variable">$host</span>;<br><span class="hljs-number">15</span>         proxy_pass http:<span class="hljs-regexp">//gu</span>limall;<br><span class="hljs-number">16</span>     &#125;<br><span class="hljs-number">17</span><br></code></pre></td></tr></table></figure>

<h1 id="三、性能压测"><a href="#三、性能压测" class="headerlink" title="三、性能压测"></a>三、性能压测</h1><h1 id="四、缓存"><a href="#四、缓存" class="headerlink" title="四、缓存"></a>四、缓存</h1><h2 id="4、分布式缓存"><a href="#4、分布式缓存" class="headerlink" title="4、分布式缓存"></a>4、分布式缓存</h2><p><img src="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/2709477518.png#crop=0&crop=0&crop=1&crop=1&id=PJHFm&originHeight=818&originWidth=1434&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=" srcset="/img/loading.gif" lazyload></p>
<p><img src="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/2530788904.png#crop=0&crop=0&crop=1&crop=1&id=ri3hy&originHeight=816&originWidth=1432&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=" srcset="/img/loading.gif" lazyload></p>
<p><img src="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/918823800.png#crop=0&crop=0&crop=1&crop=1&id=lSmfI&originHeight=800&originWidth=1400&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=" srcset="/img/loading.gif" lazyload></p>
<p><img src="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/3007685876.png#crop=0&crop=0&crop=1&crop=1&id=eKKJG&originHeight=814&originWidth=1432&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=" srcset="/img/loading.gif" lazyload></p>
<p><img src="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/3793875596.png#crop=0&crop=0&crop=1&crop=1&id=evgKy&originHeight=814&originWidth=1424&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>实现</li>
</ul>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">class</span> ServiceImpl&#123;<br>    @Override<br>    public Map&lt;String, List&lt;Catalog2Vo&gt;&gt; get<span class="hljs-constructor">CatalogJsonDbWithSpringCache()</span>&#123;<br>        <span class="hljs-comment">//给缓存中放json字符串,拿出的json需要逆转为对象：序列化/反序列化</span><br><br>        <span class="hljs-comment">//1、加入缓存逻辑，缓存中存的数据是json字符串</span><br>        <span class="hljs-comment">//好处:json跨语言、跨平台兼容</span><br>        String catalogJSON = stringRedisTemplate.ops<span class="hljs-constructor">ForValue()</span>.get(<span class="hljs-string">&quot;catalogJSON&quot;</span>);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">StringUtils</span>.</span></span>is<span class="hljs-constructor">Empty(<span class="hljs-params">catalogJSON</span>)</span>)&#123;<br>            <span class="hljs-comment">//2、缓存中没有，查询数据库</span><br>            Map&lt;String,List&lt;Catalog2Vo&gt;&gt; catalogFromDB = get<span class="hljs-constructor">CatalogJsonDb()</span>;<br>            <span class="hljs-comment">//3、查到的数据转为json放入缓存</span><br><br>            return catalogFromDB;<br>        &#125;<br>        Map&lt;String,List&lt;Catalog2Vo&gt;&gt; result = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">JSON</span>.</span></span>parse<span class="hljs-constructor">Object(<span class="hljs-params">catalogJSON</span>,<span class="hljs-params">new</span> TypeReference&lt;Map&lt;String,List&lt;Catalog2Vo&gt;&gt;&gt;()</span>&#123;&#125;);<br>        return result;<br><br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 从数据库查询并封装分类数据</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * 在此加锁</span><br><span class="hljs-comment">     * @return</span><br><span class="hljs-comment">     */</span><br>    public Map&lt;String, List&lt;Catalog2Vo&gt;&gt; get<span class="hljs-constructor">CatalogJsonDb()</span> &#123;<br>        <span class="hljs-comment">//TODO 本地锁：synchronized、JUC等，只能锁住当前进程；分布式下需要分布式锁</span><br>        <span class="hljs-comment">//synchronized (this)&#123;</span><br>        <span class="hljs-comment">//分布式锁实现</span><br>        <span class="hljs-comment">//即setNX,占位</span><br>        <span class="hljs-comment">//Boolean lock = stringRedisTemplate.opsForValue().setIfAbsent(&quot;lock&quot;, &quot;111&quot;);</span><br>        <span class="hljs-comment">//原子性操作</span><br>        String uuid = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">UUID</span>.</span></span>random<span class="hljs-constructor">UUID()</span>.<span class="hljs-keyword">to</span><span class="hljs-constructor">String()</span>;<br>        Boolean lock = stringRedisTemplate.ops<span class="hljs-constructor">ForValue()</span>.set<span class="hljs-constructor">IfAbsent(<span class="hljs-string">&quot;lock&quot;</span>, <span class="hljs-params">uuid</span>,300,TimeUnit.SECONDS)</span>;<br>        <span class="hljs-comment">//加锁成功</span><br>        <span class="hljs-keyword">if</span> (lock)&#123;<br>            <span class="hljs-comment">//如果判断为真一进来就发生中断，也会死锁，因此一整段需要原子性操作才行，</span><br>            <span class="hljs-comment">//getDataFromDB失败会导致死锁，需要设置过期时间</span><br>            stringRedisTemplate.expire(<span class="hljs-string">&quot;lock&quot;</span>,<span class="hljs-number">30</span>,TimeUnit.SECONDS);<br>            Map&lt;String, List&lt;Catalog2Vo&gt;&gt; dataFromDB;<br>            <span class="hljs-keyword">try</span> &#123;<br>                dataFromDB = get<span class="hljs-constructor">DataFromDB()</span>;<br>            &#125;finally &#123;<br>                <span class="hljs-comment">//解锁,直接删除</span><br>                <span class="hljs-comment">//stringRedisTemplate.delete(&quot;lock&quot;);</span><br>                <span class="hljs-comment">//获取值+对比删除应该为原子操作，使用lua脚本完成</span><br>                <span class="hljs-comment">//TODO 脚本可以提取到外部</span><br>                String script = <span class="hljs-string">&quot;if redis.call(&#x27;get&#x27;,KEYS[1] == ARVG[1]) then return redis.call(&#x27;del&#x27;,KEYS[1]) else return 0 end&quot;</span>;<br>                <span class="hljs-comment">//调用该脚本，传入参数</span><br>                Long lock1 = stringRedisTemplate.execute(<span class="hljs-keyword">new</span> DefaultRedisScript&lt;Long&gt;(script, <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Long</span>.</span></span><span class="hljs-keyword">class</span>),<br>                        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Arrays</span>.</span></span><span class="hljs-keyword">as</span><span class="hljs-constructor">List(<span class="hljs-string">&quot;lock&quot;</span>)</span>, uuid);<br>                <span class="hljs-comment">/*String lockValue = stringRedisTemplate.opsForValue().get(&quot;lock&quot;);</span><br><span class="hljs-comment">                if(uuid.equals(lockValue))&#123;</span><br><span class="hljs-comment">                    //删除自己的锁</span><br><span class="hljs-comment">                    stringRedisTemplate.delete(&quot;lock&quot;);</span><br><span class="hljs-comment">                &#125;*/</span><br>            &#125;<br>            return dataFromDB;<br>        &#125;<br>        <span class="hljs-comment">//加锁失败:重试</span><br>        <span class="hljs-keyword">else</span> &#123;<br>            return get<span class="hljs-constructor">CatalogJsonDb()</span>;<span class="hljs-comment">//自旋进行</span><br>        &#125;<br><span class="hljs-comment">//        &#125;</span><br>    &#125;<br><br>    <span class="hljs-keyword">private</span> Map&lt;String, List&lt;Catalog2Vo&gt;&gt; get<span class="hljs-constructor">DataFromDB()</span> &#123;<br>        <span class="hljs-comment">//得到锁之后，应该再去缓存中确定异常，没有就继续查询</span><br>        String catalogJSON = stringRedisTemplate.ops<span class="hljs-constructor">ForValue()</span>.get(<span class="hljs-string">&quot;catalogJSON&quot;</span>);<br>        <span class="hljs-keyword">if</span>(!<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">StringUtils</span>.</span></span>is<span class="hljs-constructor">Empty(<span class="hljs-params">catalogJSON</span>)</span>)&#123;<br>            <span class="hljs-comment">//缓存不为空，直接返回</span><br>            Map&lt;String,List&lt;Catalog2Vo&gt;&gt; result = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">JSON</span>.</span></span>parse<span class="hljs-constructor">Object(<span class="hljs-params">catalogJSON</span>,<span class="hljs-params">new</span> TypeReference&lt;Map&lt;String,List&lt;Catalog2Vo&gt;&gt;&gt;()</span>&#123;&#125;);<br>            return result;<br>        &#125;<br>        <span class="hljs-comment">//先查出所有</span><br>        List&lt;CategoryEntity&gt; selectList = baseMapper.select<span class="hljs-constructor">List(<span class="hljs-params">null</span>)</span>;<br>        <span class="hljs-comment">//查出所有一级分类</span><br>        List&lt;CategoryEntity&gt; level1Categories = get<span class="hljs-constructor">Level1Categories()</span>;<br>        <span class="hljs-comment">//封装数据</span><br>        Map&lt;String, List&lt;Catalog2Vo&gt;&gt; catalog1Vos = level1Categories.stream<span class="hljs-literal">()</span>.collect(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Collectors</span>.</span></span><span class="hljs-keyword">to</span><span class="hljs-constructor">Map(<span class="hljs-params">k</span> -&gt; <span class="hljs-params">k</span>.<span class="hljs-params">getCatId</span>()</span>.<span class="hljs-keyword">to</span><span class="hljs-constructor">String()</span>, v -&gt; &#123;<br>            <span class="hljs-comment">//1、每个一级分类，查到二级分类</span><br>            List&lt;CategoryEntity&gt; categoryEntities = get<span class="hljs-constructor">ParentCid(<span class="hljs-params">selectList</span>,<span class="hljs-params">v</span>.<span class="hljs-params">getCatId</span>()</span>);<br>            <span class="hljs-comment">//封装上面的结果</span><br>            List&lt;Catalog2Vo&gt; catalog2Vos = null;<br>            <span class="hljs-keyword">if</span> (categoryEntities != null) &#123;<br>                catalog2Vos = categoryEntities.stream<span class="hljs-literal">()</span>.map(l2 -&gt; &#123;<br>                    Catalog2Vo catalog2Vo = <span class="hljs-keyword">new</span> <span class="hljs-constructor">Catalog2Vo(<span class="hljs-params">l2</span>.<span class="hljs-params">getCatId</span>()</span>.<span class="hljs-keyword">to</span><span class="hljs-constructor">String()</span>, v.get<span class="hljs-constructor">CatId()</span>.<span class="hljs-keyword">to</span><span class="hljs-constructor">String()</span>, l2.get<span class="hljs-constructor">Name()</span>, null);<br>                    <span class="hljs-comment">//给二级分类找三级分类封装成vo</span><br>                    List&lt;CategoryEntity&gt; catalog3Vos = get<span class="hljs-constructor">ParentCid(<span class="hljs-params">selectList</span>,<span class="hljs-params">l2</span>.<span class="hljs-params">getCatId</span>()</span>);<br>                    <span class="hljs-keyword">if</span> (catalog3Vos != null) &#123;<br>                        List&lt;Catalog2Vo.Catalog3Vo&gt; collect = catalog3Vos.stream<span class="hljs-literal">()</span>.map(l3 -&gt; &#123;<br>                            <span class="hljs-comment">//封装成指定格式</span><br>                            Catalog2Vo.Catalog3Vo catalog3Vo = <span class="hljs-keyword">new</span> Catalog2Vo.<span class="hljs-constructor">Catalog3Vo(<span class="hljs-params">l2</span>.<span class="hljs-params">getCatId</span>()</span>.<span class="hljs-keyword">to</span><span class="hljs-constructor">String()</span>, l3.get<span class="hljs-constructor">CatId()</span>.<span class="hljs-keyword">to</span><span class="hljs-constructor">String()</span>, l3.get<span class="hljs-constructor">Name()</span>);<br>                            return catalog3Vo;<br>                        &#125;).collect(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Collectors</span>.</span></span><span class="hljs-keyword">to</span><span class="hljs-constructor">List()</span>);<br>                        <span class="hljs-comment">//封装</span><br>                        catalog2Vo.set<span class="hljs-constructor">Catalog3List(<span class="hljs-params">collect</span>)</span>;<br>                    &#125;<br>                    return catalog2Vo;<br>                &#125;).collect(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Collectors</span>.</span></span><span class="hljs-keyword">to</span><span class="hljs-constructor">List()</span>);<br>            &#125;<br>            return catalog2Vos;<br>        &#125;));<br>        String s = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">JSON</span>.</span></span><span class="hljs-keyword">to</span><span class="hljs-constructor">JSONString(<span class="hljs-params">catalog1Vos</span>)</span>;<br>        stringRedisTemplate.ops<span class="hljs-constructor">ForValue()</span>.set(<span class="hljs-string">&quot;catalogJSON&quot;</span>,s,<span class="hljs-number">1</span>, TimeUnit.DAYS);<br>        return catalog1Vos;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="5、Redisson"><a href="#5、Redisson" class="headerlink" title="5、Redisson"></a>5、Redisson</h2><blockquote>
<p>Redisson 是一个在 Redis 的基础上实现的 Java 驻内存数据网格（In-Memory Data Grid）。它不仅提供了一系列的分布式的 Java 常用对象，还提供了许多分布式服务。其中包括(<code>BitSet</code>, <code>Set</code>, <code>Multimap</code>, <code>SortedSet</code>, <code>Map</code>, <code>List</code>, <code>Queue</code>, <code>BlockingQueue</code>, <code>Deque</code>, <code>BlockingDeque</code>, <code>Semaphore</code>, <code>Lock</code>, <code>AtomicLong</code>, <code>CountDownLatch</code>, <code>Publish / Subscribe</code>, <code>Bloom filter</code>, <code>Remote service</code>, <code>Spring cache</code>, <code>Executor service</code>, <code>Live Object service</code>, <code>Scheduler service</code>) Redisson 提供了使用 Redis 的最简单和最便捷的方法。Redisson 的宗旨是促进使用者对 Redis 的关注分离（Separation of Concern），从而让使用者能够将精力更集中地放在处理业务逻辑上。</p>
</blockquote>
<ul>
<li>引入依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.redisson<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>redisson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.12.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>配置</li>
</ul>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyRedissonConfig</span> </span>&#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 所有使用都通过RedissonClient对象</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span>(destroyMethod = <span class="hljs-string">&quot;shutdown&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-function">RedissonClient <span class="hljs-title">redisson</span><span class="hljs-params">()</span><span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        <span class="hljs-comment">//创建配置</span><br>        Config config = <span class="hljs-keyword">new</span> Config();<br>        config.useClusterServers().addNodeAddress(<span class="hljs-string">&quot;127.0.0.1:6379&quot;</span>);<br>        <span class="hljs-comment">//根据config创建实例</span><br>        <span class="hljs-function"><span class="hljs-keyword">return</span> Redisson.<span class="hljs-title">create</span><span class="hljs-params">(config)</span></span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>可重入锁</strong></p>
<ul>
<li>阻塞式，看门狗机制：可自动给锁续期 30s，不担心超时被删除</li>
</ul>
<h2 id="6、缓存数据一致性"><a href="#6、缓存数据一致性" class="headerlink" title="6、缓存数据一致性"></a>6、缓存数据一致性</h2><p>缓存数据和数据库中的数据一致性</p>
<h3 id="双写"><a href="#双写" class="headerlink" title="双写"></a>双写</h3><blockquote>
<p>数据库改完改一次缓存</p>
<p>有脏数据风险</p>
</blockquote>
<p><img src="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/1806484557.png#crop=0&crop=0&crop=1&crop=1&id=qtqGJ&originHeight=988&originWidth=1728&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=" srcset="/img/loading.gif" lazyload></p>
<h3 id="失效"><a href="#失效" class="headerlink" title="失效"></a>失效</h3><blockquote>
<p>数据库修改就删除对应缓存</p>
</blockquote>
<p><img src="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/115738156.png#crop=0&crop=0&crop=1&crop=1&id=bVPX2&originHeight=978&originWidth=1724&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=" srcset="/img/loading.gif" lazyload></p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><ul>
<li>双写和失效都会导致缓存不一致，即多个实例同时更新会出事，怎么解决</li>
</ul>
<blockquote>
<p>1、如果是用户维度数据（订单数据、用户数据），并发可能小，不用考虑这个问题，缓存数据加上过期时间，每隔一段时间出发读读主动更新即可</p>
<p>2、如果是菜单，商品介绍等基础，也可以使用 cannal 订阅 binlog 的方式</p>
<p>3、缓存数据+过期时间足以解决大部分业务对缓存对要求</p>
<p>4、通过加锁保证并发读写，写写的时候按顺序排好队，读读无所谓，适合使用读写锁（业务不关心脏数据，允许临时脏数据可忽略）</p>
</blockquote>
<ul>
<li>总结</li>
</ul>
<blockquote>
<p>放入缓存的数据不应该是实时性、一致性要求超高的。所以缓存数据的适合加上过时时间，保证每天拿到最新数据即可</p>
<p>不应该过度设计，增加系统复杂性</p>
<p>遇到实时性、一致性高的数据，应该查数据库</p>
</blockquote>
<p><img src="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/1429316127.png#crop=0&crop=0&crop=1&crop=1&id=O5Jjh&originHeight=852&originWidth=1498&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=" srcset="/img/loading.gif" lazyload></p>
<h3 id="本系统缓存实现"><a href="#本系统缓存实现" class="headerlink" title="本系统缓存实现"></a>本系统缓存实现</h3><blockquote>
<p>使用失效模式</p>
<p>缓存所有数据都有过期时间、数据过期下一次查询出发主动更新</p>
<p>读写数据时，加上分布式的读写锁</p>
</blockquote>
<h2 id="7、整合-SpringCache"><a href="#7、整合-SpringCache" class="headerlink" title="7、整合 SpringCache"></a>7、整合 SpringCache</h2><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><ul>
<li>1、依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>2、配置</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cache:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">redis</span><br></code></pre></td></tr></table></figure>

<ul>
<li>4、重要注解</li>
</ul>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@Cacheable</span>：触发将数据保存到缓存的操作<br><span class="hljs-variable">@CacheEvict</span>：触发将数据从缓存删除的操作<br><span class="hljs-variable">@CachePut</span>：不影响方法执行更新缓存，双写模式<br><span class="hljs-variable">@Caching</span>：组合多个缓存操作<br><span class="hljs-variable">@CacheConfig</span>：类级别上共享相同的缓存配置<br></code></pre></td></tr></table></figure>

<ul>
<li>5、使用</li>
<li>开启缓存功能</li>
</ul>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs autoit"><span class="hljs-meta"># 在启动类上添加该注解</span><br><span class="hljs-symbol">@EnableCaching</span><br></code></pre></td></tr></table></figure>

<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">class</span> CategoryServiceImpl&#123;<br>    @<span class="hljs-constructor">Cacheable(&#123;<span class="hljs-string">&quot;category&quot;</span>&#125;)</span><br>    @Override<br>    public List&lt;CategoryEntity&gt; get<span class="hljs-constructor">Level1Categories()</span> &#123;<br>        long l = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>current<span class="hljs-constructor">TimeMillis()</span>;<br>        List&lt;CategoryEntity&gt; categoryEntities = baseMapper.select<span class="hljs-constructor">List(<span class="hljs-params">new</span> QueryWrapper&lt;CategoryEntity&gt;()</span>.eq(<span class="hljs-string">&quot;parent_cid&quot;</span>, <span class="hljs-number">0</span>));<br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>out.println(<span class="hljs-string">&quot;消耗时间： &quot;</span> + (<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>current<span class="hljs-constructor">TimeMillis()</span> - l));<br>        return categoryEntities;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>默认行为</strong></p>
<p>如果缓存中有，方法不用调用</p>
<p>key 默认自动生成，缓存名字</p>
<p>缓存的 value 默认使用 jdk 序列化机制，序列化之后存到 redis</p>
<p>默认时间-1（永不过期），需要更改</p>
<p><strong>自定义</strong></p>
<p><strong>指定生成的缓存使用的 key</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-meta"># SpEL获取方法名作为key</span><br>@Cacheable(<span class="hljs-keyword">value</span> = &#123;<span class="hljs-string">&quot;category&quot;</span>&#125;,key = <span class="hljs-string">&quot;#root.method.name&quot;</span>)<br><span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;CategoryEntity&gt; <span class="hljs-title">getLevel1Categories</span>()</span> &#123;<br></code></pre></td></tr></table></figure>

<p><strong>指定缓存数据的存活时间</strong></p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">spring</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-attribute">cache</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">type</span><span class="hljs-punctuation">:</span> <span class="hljs-string">redis</span><br>    <span class="hljs-attribute">redis</span><span class="hljs-punctuation">:</span><br>      <span class="hljs-comment"># 指定存活时间</span><br>      <span class="hljs-attribute">time-to-live</span><span class="hljs-punctuation">:</span> <span class="hljs-string">3600000</span><br></code></pre></td></tr></table></figure>

<p><strong>将数据保存为 JSON 格式</strong></p>
<ul>
<li>配置</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableConfigurationProperties(CacheProperties.class)</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableCaching</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyCacheConfig</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    RedisCacheConfiguration <span class="hljs-title function_">redisCacheConfiguration</span><span class="hljs-params">(CacheProperties cacheProperties)</span>&#123;<br>        <span class="hljs-type">RedisCacheConfiguration</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> RedisCacheConfiguration.defaultCacheConfig();<br>        <span class="hljs-comment">//key和value序列化方式</span><br>        config.serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>()));<br>        config.serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericJackson2JsonRedisSerializer</span>()));<br>        CacheProperties.<span class="hljs-type">Redis</span> <span class="hljs-variable">redisProperties</span> <span class="hljs-operator">=</span> cacheProperties.getRedis();<br>        <span class="hljs-keyword">if</span> (redisProperties.getTimeToLive() != <span class="hljs-literal">null</span>) &#123;<br>            config = config.entryTtl(redisProperties.getTimeToLive());<br>        &#125;<br>        <span class="hljs-keyword">if</span> (redisProperties.getKeyPrefix() != <span class="hljs-literal">null</span>) &#123;<br>            config = config.prefixKeysWith(redisProperties.getKeyPrefix());<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!redisProperties.isCacheNullValues()) &#123;<br>            config = config.disableCachingNullValues();<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!redisProperties.isUseKeyPrefix()) &#123;<br>            config = config.disableKeyPrefix();<br>        &#125;<br>        <span class="hljs-keyword">return</span> config;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>开发时不指定前缀，不禁用前缀模式</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cache:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">redis</span><br>    <span class="hljs-attr">redis:</span><br>      <span class="hljs-comment"># 过时时间</span><br>      <span class="hljs-attr">time-to-live:</span> <span class="hljs-number">3600000</span><br>      <span class="hljs-comment"># 如果指定前缀就使用，没指定就使用缓存名字作为前缀</span><br><span class="hljs-comment">#      key-prefix: CACHE_</span><br>      <span class="hljs-attr">use-key-prefix:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<p><strong>SpringCache 的不足</strong></p>
<p>读模式</p>
<ul>
<li>穿透：查询 null 数据。解决：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">cache<span class="hljs-operator">-</span><span class="hljs-keyword">null</span><span class="hljs-operator">-</span><span class="hljs-keyword">values</span>: <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<ul>
<li>击穿：大量并发进来查询一个正好过期的数据。解决：<strong>加锁</strong></li>
</ul>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">sync</span> = <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<ul>
<li>雪崩：大量 key 同时过期。解决：<strong>加随机时间</strong></li>
</ul>
<p>写模式</p>
<ul>
<li>读写加锁</li>
<li>引入 canal，感知 MySQL 的更新就更新数据库</li>
<li>读多写多，直接去数据库查询</li>
</ul>
<p>总结：</p>
<ul>
<li>常规数据（读多写少，即时性一致性要求不高）使用 SpringCache</li>
<li>特殊数据，特殊设计</li>
</ul>
<h1 id="五、认证"><a href="#五、认证" class="headerlink" title="五、认证"></a>五、认证</h1><h2 id="4、社交登陆"><a href="#4、社交登陆" class="headerlink" title="4、社交登陆"></a>4、社交登陆</h2><h3 id="OAuth2-0"><a href="#OAuth2-0" class="headerlink" title="OAuth2.0"></a>OAuth2.0</h3><blockquote>
<p>对于用户相关的 OpenAPI（例如获取用户信息，动态同步，照片，日志，分享等），为了保护用户数据的安全和隐私，第三方网站访问用户数据前都需要显式的向用户征求授权。</p>
</blockquote>
<p><img src="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/3730737143.png#crop=0&crop=0&crop=1&crop=1&id=zeO9D&originHeight=530&originWidth=712&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">（<span class="hljs-selector-tag">A</span>）用户打开客户端以后，客户端要求用户给予授权。<br></code></pre></td></tr></table></figure>

<p>（B）用户同意给予客户端授权。</p>
<p>（C）客户端使用上一步获得的授权，向认证服务器申请令牌。</p>
<p>（D）认证服务器对客户端进行认证以后，确认无误，同意发放令牌。</p>
<p>（E）客户端使用令牌，向资源服务器申请获取资源。</p>
<p>（F）资源服务器确认令牌无误，同意向客户端开放资源。</p>
<h2 id="5、Session"><a href="#5、Session" class="headerlink" title="5、Session"></a>5、Session</h2><h3 id="Session-共享问题解决"><a href="#Session-共享问题解决" class="headerlink" title="Session 共享问题解决"></a>Session 共享问题解决</h3><ul>
<li>session 复制</li>
</ul>
<p><img src="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/3324269510.png#crop=0&crop=0&crop=1&crop=1&id=xxTD9&originHeight=410&originWidth=1418&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>客户端存储</li>
</ul>
<p><img src="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/426564177.png#crop=0&crop=0&crop=1&crop=1&id=fAcqK&originHeight=490&originWidth=1360&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>hash 一致性</li>
</ul>
<p><img src="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/3401742783.png#crop=0&crop=0&crop=1&crop=1&id=eFWMj&originHeight=694&originWidth=1374&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>统一存储</li>
</ul>
<p><img src="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/2453611928.png#crop=0&crop=0&crop=1&crop=1&id=nefU6&originHeight=554&originWidth=1290&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>不同服务子域共享问题</li>
</ul>
<p><img src="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/1736970932.png#crop=0&crop=0&crop=1&crop=1&id=X3iBR&originHeight=604&originWidth=1274&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=" srcset="/img/loading.gif" lazyload></p>
<h2 id="6、Spring-Session"><a href="#6、Spring-Session" class="headerlink" title="6、Spring Session"></a>6、Spring Session</h2><h3 id="整合"><a href="#整合" class="headerlink" title="整合"></a>整合</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 整合spring session--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.session<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-session-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>spring:<br>  redis:<br>    host: 192.168.1.109<br>    port: 6379<br>  session:<br>    store-type: redis<br><br>@EnableredisHttpSession<br></code></pre></td></tr></table></figure>

<h3 id="核心原理"><a href="#核心原理" class="headerlink" title="核心原理"></a>核心原理</h3><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xl"><span class="hljs-number">1</span>. @EnableredisHttpSession导入RedishttpSessionConfiguration配置<br>  <span class="hljs-number">1</span>、给容器添加组件，S<span class="hljs-function"><span class="hljs-title">essionRepository</span> -&gt;</span> R<span class="hljs-function"><span class="hljs-title">edisOperationSessionRepository</span> -&gt;</span>Redis操作session的增删改查<br>  <span class="hljs-number">2</span>、SessionRepositoryFilter<br></code></pre></td></tr></table></figure>

<h2 id="7、单点登录"><a href="#7、单点登录" class="headerlink" title="7、单点登录"></a>7、单点登录</h2><p>先使用<a target="_blank" rel="noopener" href="https://github.com/xuxueli/xxl-sso">xxl-sso</a>体验单点登录</p>
<p><img src="http://lqsgoodboy.oss-cn-shanghai.aliyuncs.com/polaris_ink/usr/uploads/2021/01/15217330.png#crop=0&crop=0&crop=1&crop=1&id=aM4h1&originHeight=442&originWidth=1482&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title=" srcset="/img/loading.gif" lazyload></p>
<h1 id="六、秒杀"><a href="#六、秒杀" class="headerlink" title="六、秒杀"></a>六、秒杀</h1><blockquote>
<p>秒杀具有瞬时高并发的特点，针对这一特点，必须做到：限流+异步+缓存（页面静态化）+独立部署</p>
</blockquote>
<h2 id="1、限流方式"><a href="#1、限流方式" class="headerlink" title="1、限流方式"></a>1、限流方式</h2><ul>
<li>前端限流：高并发网站直接在前端页面限流，eg：小米验证码设计</li>
<li>nginx 限流：负载部分请求到错误到静态页面。令牌算法、漏斗算法</li>
<li>网关限流：限流的过滤器</li>
<li>代码中使用分布式信号量</li>
<li>rabbitmq 限流（能者多劳），保证发挥所有服务器的性能</li>
</ul>
<h2 id="2、定时任务"><a href="#2、定时任务" class="headerlink" title="2、定时任务"></a>2、定时任务</h2><h3 id="CRON-表达式"><a href="#CRON-表达式" class="headerlink" title="CRON 表达式"></a>CRON 表达式</h3><blockquote>
<p>Cron 表达式是一个字符串，字符串以 5 或 6 个空格隔开，分为 6 或 7 个域，每一个域代表一个含义，Cron 有如下两种语法格式：</p>
<p>（1） Seconds Minutes Hours DayofMonth Month DayofWeek Year</p>
<p>（2）*Seconds Minutes Hours DayofMonth Month DayofWeek</p>
</blockquote>
<ol>
<li>结构</li>
</ol>
<p>corn 从左到右（用空格隔开）：秒 分 小时 月份中的日期 月份 星期中的日期 年份</p>
<ol start="2">
<li>各字段的含义<table>
<thead>
<tr>
<th>字段</th>
<th>允许值</th>
<th>允许的特殊字符</th>
</tr>
</thead>
<tbody><tr>
<td>秒（Seconds）</td>
<td>0~59 的整数</td>
<td>, - _ &#x2F;     四个字符</td>
</tr>
<tr>
<td>分（<em>Minutes</em>）</td>
<td>0~59 的整数</td>
<td>, - _ &#x2F;     四个字符</td>
</tr>
<tr>
<td>小时（_Hours_）</td>
<td>0~23 的整数</td>
<td>, - _ &#x2F;     四个字符</td>
</tr>
<tr>
<td>日期（<em>DayofMonth</em>）</td>
<td>1~31 的整数（但是你需要考虑你月的天数）</td>
<td>,- _ ? &#x2F; L W C     八个字符</td>
</tr>
<tr>
<td>月份（_Month_）</td>
<td>1~12 的整数或者 JAN-DEC</td>
<td>, - _ &#x2F;     四个字符</td>
</tr>
<tr>
<td>星期（<em>DayofWeek</em>）</td>
<td>1~7 的整数或者 SUN-SAT （1&#x3D;SUN）</td>
<td>, - _ ? &#x2F; L C #     八个字符</td>
</tr>
<tr>
<td>年(可选，留空)（_Year_）</td>
<td>1970~2099</td>
<td>, - * &#x2F;     四个字符</td>
</tr>
</tbody></table>
</li>
</ol>
<p>注意事项</p>
<p>每一个域都使用数字，但还可以出现如下特殊字符，它们的含义是：</p>
<p>（1）<em>：表示匹配该域的任意值。假如在 Minutes 域使用</em>, 即表示每分钟都会触发事件。</p>
<p>（2）?：只能用在 DayofMonth 和 DayofWeek 两个域。它也匹配域的任意值，但实际不会。因为 DayofMonth 和 DayofWeek 会相互影响。例如想在每月的 20 日触发调度，不管 20 日到底是星期几，则只能使用如下写法： 13 13 15 20 _ ?, 其中最后一位只能用？，而不能使用_，如果使用*表示不管星期几都会触发，实际上并不是这样。</p>
<p>（3）-：表示范围。例如在 Minutes 域使用 5-20，表示从 5 分到 20 分钟每分钟触发一次</p>
<p>（4）&#x2F;：表示起始时间开始触发，然后每隔固定时间触发一次。例如在 Minutes 域使用 5&#x2F;20,则意味着 5 分钟触发一次，而 25，45 等分别触发一次.</p>
<p>（5）,：表示列出枚举值。例如：在 Minutes 域使用 5,20，则意味着在 5 和 20 分每分钟触发一次。</p>
<p>（6）L：表示最后，只能出现在 DayofWeek 和 DayofMonth 域。如果在 DayofWeek 域使用 5L,意味着在最后的一个星期四触发。</p>
<p>（7）W:表示有效工作日(周一到周五),只能出现在 DayofMonth 域，系统将在离指定日期的最近的有效工作日触发事件。例如：在 DayofMonth 使用 5W，如果 5 日是星期六，则将在最近的工作日：星期五，即 4 日触发。如果 5 日是星期天，则在 6 日(周一)触发；如果 5 日在星期一到星期五中的一天，则就在 5 日触发。另外一点，W 的最近寻找不会跨过月份 。</p>
<p>（8）LW:这两个字符可以连用，表示在某个月最后一个工作日，即最后一个星期五。</p>
<p>（9）#:用于确定每个月第几个星期几，只能出现在 DayofMonth 域。例如在 4#2，表示某月的第二个星期三。</p>
<p>4、常用表达式例子</p>
<p>（1）<strong>0 0 2 1 _ ? _</strong>   表示在每月的 1 日的凌晨 2 点调整任务</p>
<p>（2）**0 15 10 ? _ MON-FRI _   表示周一到周五每天上午 10:15 执行作业</p>
<p>（3）<strong>0 15 10 ? 6L 2002-2006</strong>   表示 2002-2006 年的每个月的最后一个星期五上午 10:15 执行作</p>
<p>（4）<strong>0 0 10,14,16 _ _ ?</strong>   每天上午 10 点，下午 2 点，4 点</p>
<p>（5）<strong>0 0&#x2F;30 9-17 _ _ ?</strong>   朝九晚五工作时间内每半小时</p>
<p>（6）**0 0 12 ? _ WED_     表示每个星期三中午 12 点</p>
<p>（7）<strong>0 0 12 _ _ ?</strong>   每天中午 12 点触发</p>
<p>（8）**0 15 10 ? _ _  **   每天上午 10:15 触发</p>
<p>（9）<strong>0 15 10 _ _ ?</strong>     每天上午 10:15 触发</p>
<p>（10）**0 15 10 _ _ ? _ _   每天上午 10:15 触发</p>
<p>（11）<strong>0 15 10 _ _ ? 2005</strong>    2005 年的每天上午 10:15 触发</p>
<p>（12）**0 _ 14 _ _ ?_     在每天下午 2 点到下午 2:59 期间的每 1 分钟触发</p>
<p>（13）<strong>0 0&#x2F;5 14 _ _ ?</strong>     在每天下午 2 点到下午 2:55 期间的每 5 分钟触发</p>
<p>（14）<strong>0 0&#x2F;5 14,18 _ _ ?</strong>     在每天下午 2 点到 2:55 期间和下午 6 点到 6:55 期间的每 5 分钟触发</p>
<p>（15）**0 0-5 14 _ _ ? **   在每天下午 2 点到下午 2:05 期间的每 1 分钟触发</p>
<p>（16）<strong>0 10,44 14 ? 3 WED</strong>     每年三月的星期三的下午 2:10 和 2:44 触发</p>
<p>（17）**0 15 10 ? _ MON-FRI _   周一至周五的上午 10:15 触发</p>
<p>（18）**0 15 10 15 _ ? _   每月 15 日上午 10:15 触发</p>
<p>（19）**0 15 10 L _ ? _   每月最后一日的上午 10:15 触发</p>
<p>（20）**0 15 10 ? _ 6L _   每月的最后一个星期五上午 10:15 触发</p>
<p>（21）**0 15 10 ? _ 6L 2002-2005_   2002 年至 2005 年的每月的最后一个星期五上午 10:15 触发</p>
<p>（22）**0 15 10 ? _ 6#3_   每月的第三个星期五上午 10:15 触发</p>
<p>注意</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs applescript">（<span class="hljs-number">1</span>）有些子表达式能包含一些范围或列表<br><br>　　例如：子表达式（天（星期））可以为 “MON-FRI”，“MON，WED，FRI”，“MON-WED,SAT”<br><br>“*”字符代表所有可能的值<br><br>　　因此，“*”在子表达式（月）里表示每个月的含义，“*”在子表达式（天（星期））表示星期的每一天<br><br>　　“/”字符用来指定数值的增量<br>　　例如：在子表达式（分钟）里的“<span class="hljs-number">0</span>/<span class="hljs-number">15</span>”表示从第<span class="hljs-number">0</span>分钟开始，每<span class="hljs-number">15</span>分钟<br>在子表达式（分钟）里的“<span class="hljs-number">3</span>/<span class="hljs-number">20</span>”表示从第<span class="hljs-number">3</span>分钟开始，每<span class="hljs-number">20</span>分钟（它和“<span class="hljs-number">3</span>，<span class="hljs-number">23</span>，<span class="hljs-number">43</span>”）的含义一样<br><br>　　“？”字符仅被用于天（月）和天（星期）两个子表达式，表示不指定值<br>　　当<span class="hljs-number">2</span>个子表达式其中之一被指定了值以后，为了避免冲突，需要将另一个子表达式的值设为“？”<br><br>　　“L” 字符仅被用于天（月）和天（星期）两个子表达式，它是单词“<span class="hljs-keyword">last</span>”的缩写<br>　　但是它在两个子表达式里的含义是不同的。<br>　　在天（月）子表达式中，“L”表示一个月的最后一天<br>　　在天（星期）自表达式中，“L”表示一个星期的最后一天，也就是SAT<br><br>　　如果在“L”前有具体的内容，它就具有其他的含义了<br><br>　　例如：“<span class="hljs-number">6</span>L”表示这个月的倒数第６天，“FRIL”表示这个月的最一个星期五<br>　　注意：在使用“L”参数时，不要指定列表或范围，因为这会导致问题<br></code></pre></td></tr></table></figure>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>2020-12-27-谷粒商城-分布式高级篇</div>
      <div>http://example.com/2022/08/13/yuque/2020-12-27-谷粒商城-分布式高级篇/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>John Doe</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>August 13, 2022</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/08/13/yuque/2020-12-27-ElasticSearch/" title="2020-12-27-ElasticSearch">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">2020-12-27-ElasticSearch</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/08/13/yuque/2020-12-20-JAVA8%E6%96%B0%E7%89%B9%E6%80%A7/" title="2020-12-20-JAVA8新特性">
                        <span class="hidden-mobile">2020-12-20-JAVA8新特性</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;Table of Contents</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
